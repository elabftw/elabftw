/*! elabftw 1.5.0 https://www.elabftw.net */
!function($){$.fn.extend({mention:function(options){this.opts={users:[],delimiter:"@",sensitive:!0,emptyQuery:!1,queryBy:["name","username"],typeaheadOpts:{}};var settings=$.extend({},this.opts,options),_checkDependencies=function(){if("undefined"==typeof $)throw new Error("jQuery is Required");if("undefined"==typeof $.fn.typeahead)throw new Error("Typeahead is Required");return!0},_extractCurrentQuery=function(query,caratPos){var i;for(i=caratPos;i>=0&&query[i]!=settings.delimiter;i--);return query.substring(i,caratPos)},_matcher=function(itemProps){var i;if(settings.emptyQuery){var q=this.query.toLowerCase(),caratPos=this.$element[0].selectionStart,lastChar=q.slice(caratPos-1,caratPos);if(lastChar==settings.delimiter)return!0}for(i in settings.queryBy)if(itemProps[settings.queryBy[i]]){var j,item=itemProps[settings.queryBy[i]].toLowerCase(),usernames=this.query.toLowerCase().match(new RegExp(settings.delimiter+"\\w+","g"));if(usernames)for(j=0;j<usernames.length;j++){var username=usernames[j].substring(1).toLowerCase(),re=new RegExp(settings.delimiter+item,"g"),used=this.query.toLowerCase().match(re);if(-1!=item.indexOf(username)&&null===used)return!0}}},_updater=function(item){var i,data=this.query,caratPos=this.$element[0].selectionStart;for(i=caratPos;i>=0&&data[i]!=settings.delimiter;i--);var textBefore=(data.substring(i,caratPos),data.substring(0,i)),textAfter=data.substring(caratPos),data=textBefore+settings.delimiter+item+textAfter;return this.tempQuery=data,data},_sorter=function(items){if(items.length&&settings.sensitive){var i,currentUser=_extractCurrentQuery(this.query,this.$element[0].selectionStart).substring(1),len=items.length,priorities={highest:[],high:[],med:[],low:[]},finals=[];if(1==currentUser.length){for(i=0;len>i;i++){var currentRes=items[i];currentRes.username[0]==currentUser?priorities.highest.push(currentRes):currentRes.username[0].toLowerCase()==currentUser.toLowerCase()?priorities.high.push(currentRes):-1!=currentRes.username.indexOf(currentUser)?priorities.med.push(currentRes):priorities.low.push(currentRes)}for(i in priorities){var j;for(j in priorities[i])finals.push(priorities[i][j])}return finals}}return items},_render=function(items){var that=this;return items=$(items).map(function(i,item){i=$(that.options.item).attr("data-value",item.username);var _linkHtml=$("<div />");return item.image&&_linkHtml.append('<img class="mention_image" src="'+item.image+'">'),item.name&&_linkHtml.append('<b class="mention_name">'+item.name+"</b>"),item.username&&_linkHtml.append('<span class="mention_username"> '+settings.delimiter+item.username+"</span>"),i.find("a").html(that.highlighter(_linkHtml.html())),i[0]}),items.first().addClass("active"),this.$menu.html(items),this};return $.fn.typeahead.Constructor.prototype.render=_render,this.each(function(){var _this=$(this);_checkDependencies()&&_this.typeahead($.extend({source:settings.users,matcher:_matcher,updater:_updater,sorter:_sorter},settings.typeaheadOpts))})}})}(jQuery);